<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6248994341461229"
     crossorigin="anonymous"></script>
        <title>Block Chain Oracles - Joohwan&#39;s blog</title><meta name="Description" content="Hello this is description"><meta property="og:title" content="Block Chain Oracles" />
<meta property="og:description" content="Blockchain Oracle Oracle 은 무었인가? Chainlink Education
Blockchain oracles are entities that connect blockchains to external systems, thereby enabling smart contracts to execute based upon inputs and outputs from the real world.
스마트 계약이 블록체인 외부의 데이터를 가져올 수 있게 연결해주는 entity 이다. 또한, 블록체인 안의 데이터 뿐만 아니라 외부의 데이터와 상호작용 할 수 있는 스마트 계약을 hybrid smart contract 라고 부른다.
Smart Contract 의 양면성 Smart Contract 는 blockchain 위에서 동작하기 때문에 탈중앙화가 되어있고 누군가가 임의적으로 데이터를 수정하지 못하고 코드에 의해서만 동작한다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://jwanp.github.io/posts/block-chain-oracles/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-23T19:12:15+09:00" />
<meta property="article:modified_time" content="2023-07-23T19:12:15+09:00" /><meta property="og:site_name" content="Hello this is title" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Block Chain Oracles"/>
<meta name="twitter:description" content="Blockchain Oracle Oracle 은 무었인가? Chainlink Education
Blockchain oracles are entities that connect blockchains to external systems, thereby enabling smart contracts to execute based upon inputs and outputs from the real world.
스마트 계약이 블록체인 외부의 데이터를 가져올 수 있게 연결해주는 entity 이다. 또한, 블록체인 안의 데이터 뿐만 아니라 외부의 데이터와 상호작용 할 수 있는 스마트 계약을 hybrid smart contract 라고 부른다.
Smart Contract 의 양면성 Smart Contract 는 blockchain 위에서 동작하기 때문에 탈중앙화가 되어있고 누군가가 임의적으로 데이터를 수정하지 못하고 코드에 의해서만 동작한다."/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://jwanp.github.io/posts/block-chain-oracles/" /><link rel="prev" href="http://jwanp.github.io/posts/minting-nft/" /><link rel="next" href="http://jwanp.github.io/posts/%EA%B0%9C%EB%B0%9C-%EB%B8%94%EB%A1%9C%EA%B7%B8-%EC%9D%B4%EB%A0%87%EA%B2%8C-%ED%95%98%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Block Chain Oracles",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/jwanp.github.io\/posts\/block-chain-oracles\/"
        },"image": ["https:\/\/user-images.githubusercontent.com\/77142334\/227780652-4a867037-5843-4d78-b5e7-9c27f6203e23.png"],"genre": "posts","keywords": "block-chain","wordcount":  791 ,
        "url": "http:\/\/jwanp.github.io\/posts\/block-chain-oracles\/","datePublished": "2023-07-23T19:12:15+09:00","dateModified": "2023-07-23T19:12:15+09:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "박주환"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Joohwan&#39;s blog">Joohwan&#39;s dev blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/chat/"> Chat </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Joohwan&#39;s blog">Joohwan&#39;s dev blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/chat/" title="">Chat</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Block Chain Oracles</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>박주환</a></span>&nbsp;<span class="post-category">included in <a href="/categories/tech/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Tech</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-07-23">2023-07-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;791 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/block-chain-oracle/blockchainoracleDalle.png"
        data-srcset="/images/block-chain-oracle/blockchainoracleDalle.png, /images/block-chain-oracle/blockchainoracleDalle.png 1.5x, /images/block-chain-oracle/blockchainoracleDalle.png 2x"
        data-sizes="auto"
        alt="/images/block-chain-oracle/blockchainoracleDalle.png"
        title="/images/block-chain-oracle/blockchainoracleDalle.png" width="1011" height="663" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#oracle-은-무었인가">Oracle 은 무었인가?</a>
      <ul>
        <li></li>
        <li><a href="#chainlink">Chainlink</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="blockchain-oracle">Blockchain Oracle</h1>
<h2 id="oracle-은-무었인가">Oracle 은 무었인가?</h2>
<p><a href="https://chain.link/education/blockchain-oracles" target="_blank" rel="noopener noreffer ">Chainlink Education</a></p>
<blockquote>
<p>Blockchain oracles are entities that connect <a href="https://chain.link/education-hub/blockchain" target="_blank" rel="noopener noreffer ">blockchains</a> to external systems, thereby enabling <a href="https://chain.link/education/smart-contracts" target="_blank" rel="noopener noreffer ">smart contracts</a> to execute based upon inputs and outputs from the real world.</p>
</blockquote>
<p>스마트 계약이 블록체인 외부의 데이터를 가져올 수 있게 연결해주는 entity 이다. 또한, 블록체인 안의 데이터 뿐만 아니라 외부의 데이터와 상호작용 할 수 있는 스마트 계약을 <a href="https://chain.link/education-hub/hybrid-smart-contracts" target="_blank" rel="noopener noreffer ">hybrid smart contract</a> 라고 부른다.</p>
<h4 id="smart-contract-의-양면성">Smart Contract 의 양면성</h4>
<p><strong>Smart Contract</strong> 는 blockchain 위에서 동작하기 때문에 <strong>탈중앙화</strong>가 되어있고 누군가가 <strong>임의적으로 데이터를 수정</strong>하지 못하고 <strong>코드에 의해서만 동작한다.</strong> 따라서 신뢰성이 높은 반면에 스마트계약은 <strong>블록체인 밖에 있는 정보</strong>를 가져오지 못한다는 문제점이 있다. 하지만 smart contract 를 만들다보면 외부의 정보가 필요할때가 있다.</p>
<p>웹에서는 HTTP protocol 등으로 서로 상호작용 하면서 데이터를 주고 받는다. 이처럼 스마트계약에서 <strong>블록체인 외부의 정보</strong>와 상호작용할때 쓰이는 것이 <strong>Oracle</strong> 이리고 생각된다.</p>
<p>예를들면 이더리움 시세 예측 배팅을 위한 escrow 시스템으로 스마트계약을 만들 수 있다. 이때 사용자가 예측을 하고나서 이더리움 시세를 가져오고 싶지만 블록체인 안에는 해당 정보가 없다. 따라서 블록체인 외부 서버와 통신을 해야하는데 이때 오라클이 쓰인다.</p>
<h3 id="chainlink">Chainlink</h3>
<p><a href="https://chain.link/" target="_blank" rel="noopener noreffer "><strong>Chainlink</strong></a> 는 블록체인안에서 압도적으로 많은 사용자를 보유하고 있는 BlockChain Oracle network 이다. Chainlink 를 이용해서 smart contract 에서 상호작용 하고 싶다면 <a href="https://docs.chain.link/getting-started/conceptual-overview" target="_blank" rel="noopener noreffer ">Chainlink tutorial</a> 을 참고하라.</p>
<p>이더리움 시세예측 배팅 Smart contract 를 만들때 썼던 <strong>API call</strong> 을 이용한 코드의 일부를 보면서 실제로 어떻게 쓰이는지 간단하게 설명하겠다.</p>
<ol>
<li>
<p>Jobs - 해당 jobid 에게 request 를 보내면 요청한 request 를 수행한후 response 를 스마트 계약에 다시 보내준다.</p>
<p>해당 코드에서 API Call 을 위한 <strong>Job id 는 &ldquo;ca98366cc7314957b8c012c72f05aeeb&rdquo;</strong> 이다.</p>
</li>
<li>
<p>Job 이 수행할 요청은 <strong>req 변수</strong>에 저장되어 보내지고 job 이 결과값을 response 하면 <strong>fullfill 함수</strong>에서 parameter 값으로 이를 받아서 처리한다.</p>
</li>
</ol>
<p>해당 코드는 PredictGame 의 코드 일부분만을 가져온 것 이다. 해당 smart contract 의 전체 코드가 궁금하면 <a href="https://github.com/jwanp/SKKUOracleTeam3/blob/main/contracts/PredictGame.sol" target="_blank" rel="noopener noreffer ">PredictGame.sol</a> 를 참고</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@chainlink/contracts/src/v0.8/ChainlinkClient.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@chainlink/contracts/src/v0.8/ConfirmedOwner.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/utils/Strings.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">PredictGame</span> <span class="k">is</span> <span class="n">ChainlinkClient</span><span class="p">,</span> <span class="n">ConfirmedOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">Chainlink</span> <span class="k">for</span> <span class="n">Chainlink</span><span class="p">.</span><span class="n">Request</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ERC20</span> <span class="k">private</span> <span class="n">ERCinstance</span><span class="p">;</span>    <span class="c1">// ERC20 토큰을 다루기 위한 인터페이스
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="k">public</span> <span class="n">tokenAdress</span><span class="p">;</span> <span class="c1">// This is the token address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="k">payable</span> <span class="k">public</span> <span class="n">host</span><span class="p">;</span> <span class="c1">// This is the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 토큰을 보냈을때 로그
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">event</span> <span class="nc">Transfer</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Approval</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">_owner</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">_spender</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// getDaysEthUsdPrices 를 실행할때 request 를 보내는 url 의 로그를 찍는 이벤트
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">event</span> <span class="nc">APIurl</span><span class="p">(</span><span class="kt">string</span> <span class="n">api</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//variables used for oracle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="k">private</span> <span class="n">oracle</span><span class="p">;</span> <span class="c1">// 오라클 주소
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bytes32</span> <span class="k">private</span> <span class="n">jobId</span><span class="p">;</span> <span class="c1">// jobid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="k">private</span> <span class="n">fee</span><span class="p">;</span> <span class="c1">// link fee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">RequestVolume</span><span class="p">(</span><span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">requestId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">volume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 20230607 -&gt; 0 (해당 날짜를 모두 ethUsdPrices 에 저장하면 6이 저장된다.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">uint8</span><span class="p">)</span> <span class="k">private</span> <span class="n">datetemp</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">		<span class="c1">// 20230627 -&gt; [가격1, 가격2, 가격3, 가격4]. (시작날자 -&gt; 가격 4개 매핑)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">private</span> <span class="n">ethUsdPrices</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">		<span class="kd">constructor</span><span class="p">()</span> <span class="n">ConfirmedOwner</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		        <span class="c1">// 배포된 tokenAddress 를 입력
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		        <span class="n">tokenAdress</span> <span class="o">=</span> <span class="mh">0x7caEd854Dac539EE7E28a3E42Cdc68F32665F7A6</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">		        <span class="n">ERCinstance</span> <span class="o">=</span> <span class="n">ERC20</span> <span class="p">(</span><span class="n">tokenAdress</span><span class="p">);</span> <span class="c1">// ERC20 인터페이스로 해당 token address 를 감싼다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		        <span class="n">host</span> <span class="o">=</span> <span class="k">payable</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		        <span class="c1">//default values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		        <span class="n">setChainlinkToken</span><span class="p">(</span><span class="mh">0x779877A7B0D9E8603169DdbD7836e478b4624789</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		        <span class="n">setChainlinkOracle</span><span class="p">(</span><span class="mh">0x6090149792dAAeE9D1D568c9f9a6F6B46AA29eFD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		        <span class="n">jobId</span> <span class="o">=</span> <span class="s">&#34;ca98366cc7314957b8c012c72f05aeeb&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">		        <span class="n">fee</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">LINK_DIVISIBILITY</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 0,1 * 10**18 (Varies by network and job)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">function</span> <span class="nf">getDaysEthUsdPrices</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_timestamp</span><span class="p">)</span> <span class="k">internal</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">requestId</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	        <span class="n">Chainlink</span><span class="p">.</span><span class="n">Request</span> <span class="k">memory</span> <span class="n">req</span> <span class="o">=</span> <span class="n">buildChainlinkRequest</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	            <span class="n">jobId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	            <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	            <span class="nb">this</span><span class="p">.</span><span class="n">fulfill</span><span class="p">.</span><span class="nb">selector</span>
</span></span><span class="line"><span class="cl">	        <span class="p">);</span>
</span></span><span class="line"><span class="cl">	        <span class="n">req</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	            <span class="s">&#34;get&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	            <span class="kt">string</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="s">&#34;https://min-api.cryptocompare.com/data/pricemultifull?fsyms=ETH&amp;tsyms=USD&amp;ts=&#34;</span><span class="p">,</span> <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="n">_timestamp</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	            
</span></span><span class="line"><span class="cl">	        <span class="p">);</span>
</span></span><span class="line"><span class="cl">	        <span class="c1">// requst를 보낸 URL 을 확인하는 로그를 찍는다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="n">emit</span> <span class="n">APIurl</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="s">&#34;https://min-api.cryptocompare.com/data/pricemultifull?fsyms=ETH&amp;tsyms=USD&amp;ts=&#34;</span><span class="p">,</span> <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="n">_timestamp</span><span class="p">))));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	        <span class="c1">// Set the path to find the desired data in the API response
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="n">req</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="s">&#34;RAW,ETH,USD,VOLUME24HOUR&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	        <span class="c1">// Multiply the result by 1000000000000000000 to remove decimals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="kt">int256</span> <span class="n">timesAmount</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	        <span class="n">req</span><span class="p">.</span><span class="n">addInt</span><span class="p">(</span><span class="s">&#34;times&#34;</span><span class="p">,</span> <span class="n">timesAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	        <span class="c1">// Sends the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="k">return</span> <span class="n">sendChainlinkRequest</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">fee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">function</span> <span class="nf">fulfill</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_requestId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_price</span><span class="p">)</span> <span class="k">public</span> <span class="n">recordChainlinkFulfillment</span><span class="p">(</span><span class="n">_requestId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">emit</span> <span class="n">RequestVolume</span><span class="p">(</span><span class="n">_requestId</span><span class="p">,</span> <span class="n">_price</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			<span class="c1">// datetemp[startdate] 으로 startdate 해당하는 가격을 어디까지 불러왔는지 알 수 있다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//ethUsdPrices[20230627] 이 [2131511,23155,0,0] 이면 datetemp[20230627] 의 값은 2 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// 예 datetemp[20230627] 의 값이 2 이면 20230627 에 시작하는 날짜의 가격
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span><span class="p">(</span><span class="n">datetemp</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span> 
</span></span><span class="line"><span class="cl">				<span class="n">ethUsdPrices</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)][</span><span class="n">datetemp</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">_price</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">			<span class="p">}</span> 
</span></span><span class="line"><span class="cl">			<span class="c1">// 전에 불러왔던 가격이 현재 받은 가격과 다르면 ethUsdPrices 에 저장. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// 두개의 가격이 같으면 같은 response 를 받은 것이다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ethUsdPrices</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)][</span><span class="n">datetemp</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">_price</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">				<span class="n">ethUsdPrices</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)][</span><span class="n">datetemp</span><span class="p">[</span><span class="n">getYearMonthDay</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span><span class="p">)]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">_price</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">function</span> <span class="nf">getYearMonthDay</span><span class="p">(</span><span class="kt">uint256</span> <span class="nb">timestamp</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 31556926 is the number of seconds in a year
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="kt">uint256</span> <span class="n">year</span> <span class="o">=</span> <span class="p">(</span><span class="nb">timestamp</span> <span class="o">/</span> <span class="mi">31556926</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1970</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">			<span class="c1">// 2629743 is the number of seconds in a month
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="kt">uint256</span> <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="nb">timestamp</span> <span class="o">/</span> <span class="mi">2629743</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">			<span class="kt">uint256</span> <span class="n">day</span> <span class="o">=</span> <span class="p">(</span><span class="nb">timestamp</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">%</span> <span class="mi">31</span><span class="p">;</span> <span class="c1">// 86400 is the number of seconds in a day
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Combine the components into a single uint256 value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="kt">uint256</span> <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="n">day</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">mapping variables</th>
<th style="text-align:center">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mapping(uint256 =&gt; uint8) <strong>datetemp</strong></td>
<td style="text-align:center">해당 날짜에 해당하는 req 가 완료될때마다 1 씩 증가한다.</td>
</tr>
<tr>
<td style="text-align:center">mapping(uint256 =&gt; uint256[4]) <strong>ethUsdPrices</strong></td>
<td style="text-align:center">해당 날짜에 해당하는 req 가 완료될때마다 <!-- raw HTML omitted -->ETH/USD 시세를 저장한다.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">함수 variables</th>
<th style="text-align:center">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>getYearMonthDay</strong>(uint256 timestamp) returns date</td>
<td style="text-align:center">timestamp 를 날짜로 바꿔준다. ex) 16782917 → 20200702</td>
</tr>
<tr>
<td style="text-align:center"><strong>getDaysEthUsdPrices</strong>(uint256 _timestamp)</td>
<td style="text-align:center">해당 timestamp 에 해당하는 ETH/USD 시세에 대한 API call 을 보낸다.</td>
</tr>
<tr>
<td style="text-align:center"><strong>fulfill</strong>(bytes32 _requestId, uint256 _price)</td>
<td style="text-align:center">response 를 받아서 스마트 계약 변수에 저장한다. fullfill 함수는 response 가 오면 자동으로 실행 되기 때문에 따로 실행해주지 않아도 된다.</td>
</tr>
</tbody>
</table>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-07-23</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-title="Block Chain Oracles" data-hashtags="block-chain"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-hashtag="block-chain"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="http://jwanp.github.io/posts/block-chain-oracles/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-title="Block Chain Oracles"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-title="Block Chain Oracles"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-title="Block Chain Oracles" data-image="/images/block-chain-oracle/blockchainoracleDalle.png"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://jwanp.github.io/posts/block-chain-oracles/" data-title="Block Chain Oracles" data-description=""><i class="fab fa-blogger fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/block-chain/">block-chain</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/minting-nft/" class="prev" rel="prev" title="Minting Nft"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Minting Nft</a>
            <a href="/posts/%EA%B0%9C%EB%B0%9C-%EB%B8%94%EB%A1%9C%EA%B7%B8-%EC%9D%B4%EB%A0%87%EA%B2%8C-%ED%95%98%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C/" class="next" rel="next" title="개발 블로그 이렇게 하면 어떨까?">개발 블로그 이렇게 하면 어떨까?<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">박주환</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"Comment","lightTheme":"github-light","repo":"jwanp/blog-comment"}},"search":{"algoliaAppID":"6QK332EH1T","algoliaIndex":"jwanp","algoliaSearchKey":"79b39b96ee30ec1c39a4bf1a4037c605","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-DZ2VH32QXR', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-DZ2VH32QXR" async></script></body>
</html>
